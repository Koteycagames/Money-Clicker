<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Money Clicker $$$</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <link rel="stylesheet" href="style.css">
    
    <script src="https://pl28381542.effectivegatecpm.com/a7/c6/45/a7c6454f1cdb67023344f46b3d0d4773.js"></script>
</head>
<body>

    <div id="loading-overlay">
        <div class="loader-spinner"></div>
        <h2 style="color:white;">–ó–∞–≥—Ä—É–∑–∫–∞...</h2>
    </div>

    <div id="game-ui">
        <div class="top-bar">
            <div id="money-display">$0.00</div>
            <button id="add-money-btn" class="plus-btn">+</button>
        </div>
        <div id="cpc-display">–ö–ª–∏–∫: $0.01</div>

        <div class="left-sidebar">
            <button id="open-shop-btn" class="menu-btn"><span>üõí</span> –ú–∞–≥–∞–∑–∏–Ω</button>
            <button id="quests-btn" class="menu-btn" onclick="alert('–ö–≤–µ—Å—Ç—ã –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ!')"><span>üìú</span> –ö–≤–µ—Å—Ç—ã</button>
        </div>

        <button id="click-btn">–ö–õ–ò–ö</button>

        <div class="bottom-left">
            <button id="logoutBtn" class="logout-btn-small">–í—ã–π—Ç–∏</button>
            <div id="user-info" style="font-size: 0.6rem; color: #555; margin-top: 5px;">ID: ...</div>
        </div>

        <div class="bottom-banner-container">
            <script>
              atOptions = { 'key' : 'ba5b233760526a810caa77cf17293467', 'format' : 'iframe', 'height' : 90, 'width' : 728, 'params' : {} };
            </script>
            <script src="https://www.highperformanceformat.com/ba5b233760526a810caa77cf17293467/invoke.js"></script>
        </div>
    </div>

    <div id="shop-modal" class="modal-overlay">
        <div class="shop-modal-content">
            <div style="display:flex; justify-content:space-between; align-items:center; padding-bottom:10px; border-bottom:1px solid #444;">
                <h2 style="margin:0; color:#ff9800;">–ú–∞–≥–∞–∑–∏–Ω</h2>
                <button class="close-btn" id="close-shop-x">√ó</button>
            </div>
            <div id="shop-list" class="shop-list-scroll"><p>–ó–∞–≥—Ä—É–∑–∫–∞...</p></div>
        </div>
    </div>

    <div id="exchange-modal" class="modal-overlay">
        <div class="modal-content">
            <button class="close-btn" id="close-exchange-x">√ó</button>
            <h3 style="color:#4caf50;">–ü–æ–ª—É—á–∏—Ç—å –¥–µ–Ω—å–≥–∏</h3>
            <div id="exchange-options" class="exchange-list">
                <div class="exchange-item" onclick="startAdSequence(1, 0.30)"><span class="exchange-reward">$0.30</span><span class="exchange-cost">1 –†–µ–∫–ª–∞–º–∞</span></div>
                <div class="exchange-item" onclick="startAdSequence(2, 0.70)"><span class="exchange-reward">$0.70</span><span class="exchange-cost">2 –†–µ–∫–ª–∞–º—ã</span></div>
                <div class="exchange-item" onclick="startAdSequence(3, 1.50)"><span class="exchange-reward">$1.50</span><span class="exchange-cost">3 –†–µ–∫–ª–∞–º—ã üî•</span></div>
                <div class="exchange-item" onclick="startAdSequence(4, 3.00)"><span class="exchange-reward">$3.00</span><span class="exchange-cost">4 –†–µ–∫–ª–∞–º—ã üî•</span></div>
                <div class="exchange-item" onclick="startAdSequence(5, 5.00)"><span class="exchange-reward">$5.00</span><span class="exchange-cost">5 –†–µ–∫–ª–∞–º üî•</span></div>
            </div>
            <div id="exchange-process" class="watch-process">
                <p style="color:#ccc;">–ü—Ä–æ—Å–º–æ—Ç—Ä —Ä–µ–∫–ª–∞–º—ã...</p>
                <h2 id="exchange-step-counter" style="color:white;">1 / 3</h2>
                <div id="cooldown-msg" style="display:none;"><p class="timer-text">–ñ–¥–µ–º 15 —Å–µ–∫...</p></div>
                <button id="exchange-watch-btn" style="background:#4caf50; width:100%; padding:10px; margin-top:10px; border:none; border-radius:5px; color:white; font-weight:bold;">–°–º–æ—Ç—Ä–µ—Ç—å</button>
            </div>
        </div>
    </div>

    <div id="ad-modal" class="modal-overlay">
        <div class="modal-content">
            <h3>üéÅ –ë–æ–Ω—É—Å!</h3>
            <p>–ù–∞–≥—Ä–∞–¥–∞: <span id="reward-text" style="color:#ffd700; font-weight:bold;">???</span></p>
            <p style="margin: 10px 0; color: #fff;">–†–µ–∫–ª–∞–º: <span id="ads-counter" style="color: #4caf50;">0/0</span></p>
            <button id="watch-ad-btn" style="background:#4caf50; width:100%; padding:10px; border:none; border-radius:5px; color:white;">–°–º–æ—Ç—Ä–µ—Ç—å</button>
            <button id="close-modal-btn" style="background:#f44336; width:100%; padding:8px; margin-top:5px; border:none; border-radius:5px; color:white;">–û—Ç–º–µ–Ω–∞</button>
        </div>
    </div>

    <script type="module">
        import { auth, db } from './firebase-config.js';
        import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
        import { ref, onValue, set, update } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

        const AD_LINK = "https://www.effectivegatecpm.com/n7h7t8tnc?key=63d760e9d5c26b2ae739b39ba4062a5f"; 
        const SHOP_ITEMS = [
            { id: "wool", name: "–®–µ—Ä—Å—Ç—è–Ω–æ–µ –ø–µ—á–µ–Ω—å–µ", price: 1, power: 0.10 },
            { id: "salt", name: "–°–æ–ª–µ–≤–æ–µ –ø–µ—á–µ–Ω—å–µ", price: 3, power: 0.30 },
            { id: "coal", name: "–£–≥–æ–ª—å–Ω–æ–µ –ø–µ—á–µ–Ω—å–µ", price: 5, power: 0.50 },
            { id: "foil", name: "–ü–µ—á–µ–Ω—å–µ –∏–∑ —Ñ–æ–ª—å–≥–∏", price: 30, power: 1.00 },
            { id: "alum", name: "–ê–ª—é–º–∏–Ω–∏–µ–≤–æ–µ –ø–µ—á–µ–Ω—å–µ", price: 150, power: 1.50 },
            { id: "leaf", name: "–õ–∏—Å—Ç–æ–≤–æ–µ –ø–µ—á–µ–Ω—å–µ", price: 400, power: 2.00 },
            { id: "copper", name: "–ú–µ–¥–Ω–æ–µ –ø–µ—á–µ–Ω—å–µ", price: 800, power: 3.00 },
            { id: "lead", name: "–°–≤–∏–Ω—Ü–æ–≤–æ–µ –ø–µ—á–µ–Ω—å–µ", price: 1000, power: 4.50 },
            { id: "tungsten", name: "–í–æ–ª—å—Ñ—Ä–∞–º–æ–≤–æ–µ –ø–µ—á–µ–Ω—å–µ", price: 1300, power: 6.00 },
            { id: "silver", name: "–°–µ—Ä–µ–±—Ä—è–Ω–æ–µ –ø–µ—á–µ–Ω—å–µ", price: 1750, power: 8.00 },
            { id: "gold", name: "–ó–æ–ª–æ—Ç–æ–µ –ø–µ—á–µ–Ω—å–µ", price: 2000, power: 10.00 },
            { id: "emerald", name: "–ò–∑—É–º—Ä—É–¥–Ω–æ–µ –ø–µ—á–µ–Ω—å–µ", price: 2400, power: 13.00 },
            { id: "diamond", name: "–ê–ª–º–∞–∑–Ω–æ–µ –ø–µ—á–µ–Ω—å–µ", price: 3500, power: 20.00 },
            { id: "rainbow", name: "–†–∞–¥—É–∂–Ω–æ–µ –ø–µ—á–µ–Ω—å–µ", price: 5000, power: 30.00 }
        ];

        let currentMoney = 0.00;
        let clickPower = 0.01; 
        let userId = null;
        let isCooldown = false;
        let ownedUpgrades = []; 
        let equippedItem = "none";
        let isDataLoaded = false;
        let isInitialLoadDone = false;

        window.startAdSequence = startAdSequence;
        let exTotalAds = 0; let exCurrentAd = 0; let exReward = 0;
        let adsRequired = 0; let adsWatchedCount = 0; let currentReward = null;
        let balloonTimerInterval = null;

        onAuthStateChanged(auth, (user) => {
            if (user) {
                userId = user.uid;
                document.getElementById('user-info').innerText = "ID: " + user.email;
                
                const userRef = ref(db, 'users/' + userId);
                onValue(userRef, (snapshot) => {
                    const data = snapshot.val();
                    if (data) {
                        if (data.banned) { window.location.href = "ban.html"; return; }
                        currentMoney = parseFloat(data.money) || 0;
                        ownedUpgrades = data.upgrades || ["start"];
                        equippedItem = data.equipped || "none";
                        recalcClickPower();
                        updateDisplay();
                        renderShop();
                        
                        if (!isInitialLoadDone) {
                            isInitialLoadDone = true; 
                            setTimeout(() => {
                                isDataLoaded = true;
                                const loader = document.getElementById('loading-overlay');
                                if (loader) { 
                                    loader.classList.add('hidden'); // –î–æ–±–∞–≤–ª—è–µ–º –∫–ª–∞—Å—Å –¥–ª—è —Å–∫—Ä—ã—Ç–∏—è
                                    setTimeout(() => loader.remove(), 500); 
                                }
                            }, 1500);
                        }
                    }
                });
                startBalloonSpawner();
            } else { window.location.href = "index.html"; }
        });

        function recalcClickPower() {
            if (equippedItem === "none" || equippedItem === "start") { clickPower = 0.01; return; }
            const item = SHOP_ITEMS.find(i => i.id === equippedItem);
            clickPower = item ? item.power : 0.01;
        }

        const clickBtn = document.getElementById('click-btn');
        clickBtn.addEventListener('click', () => {
            if (!userId || isCooldown || !isDataLoaded) return;
            isCooldown = true;
            clickBtn.classList.add('cooldown');
            currentMoney += clickPower;
            updateDisplay();
            set(ref(db, 'users/' + userId + '/money'), parseFloat(currentMoney.toFixed(2)));
            setTimeout(() => { isCooldown = false; clickBtn.classList.remove('cooldown'); }, 1000);
        });

        function updateDisplay() {
            document.getElementById('money-display').innerText = '$' + currentMoney.toFixed(2);
            document.getElementById('cpc-display').innerText = '–ó–∞ –∫–ª–∏–∫: $' + clickPower.toFixed(2);
        }

        const exchangeModal = document.getElementById('exchange-modal');
        const uiContainer = document.getElementById('game-ui');

        document.getElementById('add-money-btn').addEventListener('click', () => {
            exchangeModal.classList.add('open');
            uiContainer.classList.add('blur-active');
            resetExchangeUI();
        });
        document.getElementById('close-exchange-x').addEventListener('click', () => {
            exchangeModal.classList.remove('open');
            uiContainer.classList.remove('blur-active');
        });

        function resetExchangeUI() {
            document.getElementById('exchange-options').style.display = 'flex';
            document.getElementById('exchange-process').classList.remove('active');
        }

        function startAdSequence(count, reward) {
            exTotalAds = count; exReward = reward; exCurrentAd = 0;
            document.getElementById('exchange-options').style.display = 'none';
            document.getElementById('exchange-process').classList.add('active');
            updateExchangeStep();
        }

        function updateExchangeStep() {
            document.getElementById('exchange-step-counter').innerText = `${exCurrentAd} / ${exTotalAds}`;
            const btn = document.getElementById('exchange-watch-btn');
            if (exCurrentAd >= exTotalAds) giveExchangeReward();
            else { btn.disabled = false; btn.innerText = "–°–º–æ—Ç—Ä–µ—Ç—å —Ä–µ–∫–ª–∞–º—É"; btn.style.display = 'block'; }
        }

        document.getElementById('exchange-watch-btn').addEventListener('click', () => {
            const btn = document.getElementById('exchange-watch-btn');
            window.open(AD_LINK, '_blank');
            btn.innerText = "–ü—Ä–æ–≤–µ—Ä–∫–∞..."; btn.disabled = true;
            setTimeout(() => {
                exCurrentAd++;
                if (exTotalAds >= 3 && exCurrentAd < exTotalAds) startCooldownTimer();
                else updateExchangeStep();
            }, 3000);
        });

        function startCooldownTimer() {
            const msg = document.getElementById('cooldown-msg');
            const btn = document.getElementById('exchange-watch-btn');
            document.getElementById('exchange-step-counter').innerText = `${exCurrentAd} / ${exTotalAds}`;
            msg.style.display = 'block'; btn.style.display = 'none';
            let seconds = 15;
            const timer = setInterval(() => {
                seconds--;
                msg.querySelector('.timer-text').innerText = `–ñ–¥–µ–º ${seconds} —Å–µ–∫...`;
                if (seconds <= 0) { clearInterval(timer); msg.style.display = 'none'; updateExchangeStep(); }
            }, 1000);
        }

        function giveExchangeReward() {
            currentMoney += exReward;
            update(ref(db, 'users/' + userId), { money: parseFloat(currentMoney.toFixed(2)) });
            alert(`–í—ã –ø–æ–ª—É—á–∏–ª–∏ $${exReward.toFixed(2)}!`);
            exchangeModal.classList.remove('open'); uiContainer.classList.remove('blur-active');
        }

        const shopModal = document.getElementById('shop-modal');
        document.getElementById('open-shop-btn').addEventListener('click', () => {
            shopModal.classList.add('open'); uiContainer.classList.add('blur-active');
        });
        document.getElementById('close-shop-x').addEventListener('click', () => {
            shopModal.classList.remove('open'); uiContainer.classList.remove('blur-active');
        });

        function renderShop() {
            const list = document.getElementById('shop-list'); list.innerHTML = ""; 
            SHOP_ITEMS.forEach(item => {
                const isOwned = ownedUpgrades.includes(item.id);
                const isEquipped = (equippedItem === item.id);
                const el = document.createElement('div');
                el.className = "shop-item " + (isEquipped ? "equipped" : "");
                let btnHtml = isEquipped ? `<button class="action-btn btn-equipped">–ù–∞–¥–µ—Ç–æ</button>` :
                              isOwned ? `<button class="action-btn btn-equip" id="eq-${item.id}">–ù–∞–¥–µ—Ç—å</button>` :
                              `<button class="action-btn btn-buy" id="buy-${item.id}">$${item.price}</button>`;
                el.innerHTML = `<div><h4>${item.name}</h4><p>+$${item.power}</p></div>${btnHtml}`;
                list.appendChild(el);
                if(!isEquipped && isOwned) document.getElementById(`eq-${item.id}`).onclick = () => equipItem(item.id);
                if(!isOwned) document.getElementById(`buy-${item.id}`).onclick = () => buyItem(item);
            });
            const unequip = document.createElement('div'); unequip.style.textAlign='center'; unequip.style.marginTop='10px';
            unequip.innerHTML = `<button style="background:#f44336; color:white; border:none; padding:5px 10px; border-radius:5px;">–°–Ω—è—Ç—å –≤—Å—ë</button>`;
            unequip.onclick = () => equipItem("none");
            list.appendChild(unequip);
        }

        function buyItem(item) {
            if (!isDataLoaded) return;
            if (currentMoney >= item.price) {
                currentMoney -= item.price;
                let newUpgrades = [...ownedUpgrades, item.id];
                update(ref(db, 'users/' + userId), { money: parseFloat(currentMoney.toFixed(2)), upgrades: newUpgrades });
            } else alert("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–µ–Ω–µ–≥!");
        }
        function equipItem(id) {
            if (!isDataLoaded) return;
            update(ref(db, 'users/' + userId), { equipped: id });
        }

        // --- –¢–ê–ô–ú–ï–† –ò–°–ü–†–ê–í–õ–ï–ù ---
        function startBalloonSpawner() {
            if (balloonTimerInterval) clearInterval(balloonTimerInterval);
            
            // –í—Ä–µ–º—è –æ—Ç 60 –¥–æ 180 —Å–µ–∫—É–Ω–¥
            const waitTime = Math.floor(Math.random() * (180000 - 60000) + 60000);
            const targetTime = Date.now() + waitTime;
            
            console.log("%cüéÅ –¢–∞–π–º–µ—Ä –∑–∞–ø—É—â–µ–Ω!", "color: yellow; font-weight: bold;");

            balloonTimerInterval = setInterval(() => {
                const now = Date.now();
                const diff = targetTime - now;
                const secondsLeft = Math.ceil(diff / 1000);

                if (diff <= 0) {
                    clearInterval(balloonTimerInterval);
                    console.log("%cüéÅ –í–†–ï–ú–Ø! –í—ã–ø—É—Å–∫–∞–µ–º —à–∞—Ä–∏–∫!", "color: lime; font-weight: bold; font-size: 14px;");
                    spawnBalloon();
                    // –†–µ–∫—É—Ä—Å–∏–≤–Ω—ã–π –∑–∞–ø—É—Å–∫ —Å–ª–µ–¥—É—é—â–µ–≥–æ —Ç–∞–π–º–µ—Ä–∞
                    startBalloonSpawner();
                } else {
                    console.log(`‚è≥ –î–æ –ø–æ–¥–∞—Ä–∫–∞: ${secondsLeft} —Å–µ–∫`);
                }
            }, 1000);
        }

        function spawnBalloon() {
            const b = document.createElement('div');
            b.className = "bonus-balloon";
            b.style.left = (Math.random()*70+10)+"%";
            let top = -100;
            const spd = 2+Math.random()*2;
            document.body.appendChild(b);
            const t = setInterval(()=>{
                top+=spd; b.style.top=top+"px";
                if(top>window.innerHeight){clearInterval(t);b.remove();}
            },20);
            b.onclick = () => { clearInterval(t); b.remove(); generateOffer(); }
        }

        function generateOffer() {
            const rand = Math.random() * 100;
            let type="", val=0, id="";
            if (rand < 40) { type="money"; val=0.30; }
            else if (rand < 70) { type="money"; val=0.50; }
            else if (rand < 85) { type="money"; val=1.00; }
            else if (rand < 92) { type="item"; id="salt"; }
            else if (rand < 96) { type="money"; val=1.50; }
            else if (rand < 98) { type="item"; id="wool"; }
            else { type="item"; id="coal"; }

            if(type==="money") currentReward={type:"money", value:val, text:`$${val.toFixed(2)}`};
            else {
                const i = SHOP_ITEMS.find(x=>x.id===id);
                currentReward={type:"item", id:id, text:i.name};
                if(ownedUpgrades.includes(id)) currentReward={type:"money", value:i.price, text:`$${i.price} (–ü–æ–≤—Ç–æ—Ä)`};
            }
            
            adsRequired = (type==="money" && val<=1) ? 1 : 2;
            adsWatchedCount=0;
            updateAdModalUI();
            document.getElementById('ad-modal').classList.add('open');
            uiContainer.classList.add('blur-active');
        }

        function updateAdModalUI() {
            document.getElementById('reward-text').innerText = currentReward.text;
            document.getElementById('ads-counter').innerText = `${adsWatchedCount}/${adsRequired}`;
            const btn = document.getElementById('watch-ad-btn');
            btn.innerText = (adsWatchedCount>0 && adsWatchedCount<adsRequired) ? "–°–º–æ—Ç—Ä–µ—Ç—å —Å–ª–µ–¥—É—é—â—É—é" : "–°–º–æ—Ç—Ä–µ—Ç—å";
        }

        document.getElementById('watch-ad-btn').onclick = () => {
            window.open(AD_LINK);
            const btn=document.getElementById('watch-ad-btn');
            btn.innerText="–ü—Ä–æ–≤–µ—Ä–∫–∞..."; btn.disabled=true;
            setTimeout(()=>{
                adsWatchedCount++; btn.disabled=false;
                if(adsWatchedCount>=adsRequired) {
                    giveBonusReward();
                    document.getElementById('ad-modal').classList.remove('open');
                    uiContainer.classList.remove('blur-active');
                } else updateAdModalUI();
            },3000);
        };

        document.getElementById('close-modal-btn').onclick = () => {
            document.getElementById('ad-modal').classList.remove('open');
            uiContainer.classList.remove('blur-active');
        }

        function giveBonusReward() {
            if(currentReward.type==="money") {
                currentMoney+=currentReward.value;
                update(ref(db,'users/'+userId),{money:parseFloat(currentMoney.toFixed(2))});
            } else {
                let nu = [...ownedUpgrades, currentReward.id];
                update(ref(db,'users/'+userId),{upgrades:nu});
            }
            alert("–ë–æ–Ω—É—Å –ø–æ–ª—É—á–µ–Ω!");
        }

        document.getElementById('logoutBtn').addEventListener('click', () => {
            signOut(auth).then(() => { window.location.href = "index.html"; });
        });
    </script>
</body>
</html>
